generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model User {
  id            String         @id @default(uuid())
  email         String         @unique
  passwordHash  String?        @map("password_hash")
  name          String?
  provider      String         @default("email")
  providerId    String?        @map("provider_id")
  avatarUrl     String?        @map("avatar_url")
  createdAt     DateTime       @default(now()) @map("created_at")
  updatedAt     DateTime       @updatedAt @map("updated_at")
  isPromo       Boolean        @default(false) @map("is_promo")
  instances     Instance[]
  openRouterKey OpenRouterKey?

  @@unique([provider, providerId])
  @@map("users")
}

model Instance {
  id              String           @id @default(uuid())
  instanceId      String           @unique @map("instance_id")
  userId          String           @map("user_id")
  user            User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  displayName     String?          @map("display_name")
  installedSkills InstalledSkill[]
  createdAt       DateTime         @default(now()) @map("created_at")
  updatedAt       DateTime         @updatedAt @map("updated_at")

  @@index([userId])
  @@map("instances")
}

model InstalledSkill {
  id          String   @id @default(uuid())
  instanceId  String   @map("instance_id")
  instance    Instance @relation(fields: [instanceId], references: [id], onDelete: Cascade)
  slug        String
  version     String
  displayName String?  @map("display_name")
  summary     String?
  installedAt DateTime @default(now()) @map("installed_at")

  @@unique([instanceId, slug])
  @@index([instanceId])
  @@map("installed_skills")
}

model OpenRouterKey {
  id         String   @id @default(uuid())
  userId     String   @unique @map("user_id")
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  key        String
  keyHash    String   @map("key_hash")
  name       String
  limit      Float
  limitReset String   @map("limit_reset")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  @@map("open_router_keys")
}
